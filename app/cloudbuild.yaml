steps:
  # Build imagen
  - name: gcr.io/cloud-builders/docker
    dir: app
    args:
      [
        "build",
        "-t",
        "us-central1-docker.pkg.dev/$PROJECT_ID/staging-repo/devops-demo-api:$SHORT_SHA",
        "."
      ]

  # Push imagen
  - name: gcr.io/cloud-builders/docker
    args:
      [
        "push",
        "us-central1-docker.pkg.dev/$PROJECT_ID/staging-repo/devops-demo-api:$SHORT_SHA"
      ]

  - name: 'gcr.io/cloud-builders/helm' # Cambio clave aqu√≠
    env:
      - 'CLOUDSDK_CONTAINER_CLUSTER=staging-cluster'
      - 'CLOUDSDK_COMPUTE_REGION=us-central1'
    args:
      - 'upgrade'
      - '--install'
      - 'devops-test-api'
      - './helm/devops-test-api'
      - '--namespace'
      - 'staging'
      - '--create-namespace'
      - '--set'
      - 'image.repository=us-central1-docker.pkg.dev/$PROJECT_ID/staging-repo/devops-demo-api'
      - '--set'
      - 'image.tag=$SHORT_SHA'

images:
  - us-central1-docker.pkg.dev/$PROJECT_ID/staging-repo/devops-demo-api:$SHORT_SHA

options:
  logging: CLOUD_LOGGING_ONLY